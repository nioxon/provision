#!/usr/bin/env bash
set -e

BASE_DIR="/opt/nioxon"
CONFIG_DIR="$BASE_DIR/config"
PROVISION_DIR="$BASE_DIR/provision"
RUNTIME_ENV="$CONFIG_DIR/runtime.env"
STATE_FILE="$CONFIG_DIR/state.log"

# Ensure config directory exists & writable
mkdir -p "$CONFIG_DIR"
chmod 755 "$CONFIG_DIR"

# ---------------- UI ----------------
green(){ echo -e "\033[32m$1\033[0m"; }
red(){ echo -e "\033[31m$1\033[0m"; }
yellow(){ echo -e "\033[33m$1\033[0m"; }
bold(){ echo -e "\033[1m$1\033[0m"; }

spinner() {
  local pid=$1
  local spin='-\|/'
  while kill -0 "$pid" 2>/dev/null; do
    for i in {0..3}; do
      printf "\r  %s " "${spin:$i:1}"
      sleep 0.1
    done
  done
  printf "\r"
}

# ---------------- RESUME / RETRY ----------------
mark_done() {
  grep -qx "$1" "$STATE_FILE" 2>/dev/null || echo "$1" >> "$STATE_FILE"
}

is_done() {
  grep -qx "$1" "$STATE_FILE" 2>/dev/null
}

reset_state() {
  rm -f "$STATE_FILE"
}

# ---------------- Helpers ----------------
detect_lan() {
  nmcli -t -f DEVICE,TYPE device | awk -F: '$2=="ethernet"{print $1; exit}'
}

detect_wifi() {
  nmcli -t -f DEVICE,TYPE device | awk -F: '$2=="wifi"{print $1; exit}'
}

require_internet() {
  curl -fsSL https://google.com >/dev/null || {
    red "âŒ Internet not available"
    exit 1
  }
}

# ---------------- Step Runner (WITH RESUME) ----------------
run_step() {
  local step="$1"
  local label="$2"

  if is_done "$step"; then
    yellow "â€¢ $label (skipped)"
    return
  fi

  printf "â€¢ %-30s" "$label"
  bash "$PROVISION_DIR/$step.sh" &
  spinner $!
  wait $! && {
    green "âœ” Done"
    mark_done "$step"
  } || {
    red "âœ– Failed ($step)"
    exit 1
  }
}

# ---------------- Commands ----------------
configure() {
  bold "âš™ï¸ NIOXON Configuration"

  LAN_IFACE=$(detect_lan)
  WIFI_IFACE=$(detect_wifi)

  read -p "Project name [nioxon]: " PROJECT_NAME
  PROJECT_NAME=${PROJECT_NAME:-nioxon}

  read -p "Domain [nioxplay.portal]: " SITE_DOMAIN
  SITE_DOMAIN=${SITE_DOMAIN:-nioxplay.portal}


  read -p "LAN interface [$LAN_IFACE]: " IN_LAN
  LAN_IFACE=${IN_LAN:-$LAN_IFACE}

  read -p "LAN IP [192.168.1.2]: " LAN_IP
  LAN_IP=${LAN_IP:-192.168.1.2}

  read -p "LAN subnet [24]: " LAN_NETMASK
  LAN_NETMASK=${LAN_NETMASK:-24}

  cat > "$RUNTIME_ENV" <<EOF
PROJECT_NAME=$PROJECT_NAME
SITE_DOMAIN=$SITE_DOMAIN
LAN_IFACE=$LAN_IFACE
LAN_IP=$LAN_IP
LAN_NETMASK=$LAN_NETMASK
WIFI_IFACE=$WIFI_IFACE
EOF

  green "âœ” Configuration saved"
}

install() {
  bold "ðŸš€ NIOXON Provisioning"

  [ ! -f "$RUNTIME_ENV" ] && {
    red "Run: nioxon configure"
    exit 1
  }

  source "$RUNTIME_ENV"
  require_internet

  bold "ðŸ”µ Phase 1 â€” System"
  run_step "00-system" "System update"
  run_step "01-security" "Security"
  run_step "02-network-manager" "NetworkManager"
  run_step "03-nginx" "Nginx"
  run_step "04-php" "PHP"
  run_step "05-mysql" "MySQL"
  run_step "06-node" "Node.js"
  run_step "07-redis" "Redis"
  run_step "08-supervisor" "Supervisor"

  bold "âš  Phase 2 â€” Captive Network"
  run_step "10-lan" "LAN Netplan"
  run_step "11-dns" "Captive DNS"
  run_step "12-redirect" "HTTP Redirect"
  run_step "13-nioxplay-app" "Niox Play App Setup"

  green "ðŸŽ‰ Done â†’ http://$SITE_DOMAIN"
}

setup() {
  reset_state
  configure
  install
}

# ---------------- Router ----------------
case "$1" in
  setup) setup ;;
  configure) configure ;;
  install) install ;;
  *)
    echo "NIOXON CLI"
    echo "  nioxon setup"
    echo "  nioxon configure"
    echo "  nioxon install"
    ;;
esac
