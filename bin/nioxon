#!/usr/bin/env bash
set -euo pipefail

BASE="/opt/nioxon"
CFG="$BASE/config"
PROV="$BASE/provision"
STATE="$CFG/state.json"
RUNTIME="$CFG/runtime.env"

mkdir -p "$CFG"
[ -f "$STATE" ] || echo "{}" > "$STATE"

green(){ echo -e "\033[32m$1\033[0m"; }
red(){ echo -e "\033[31m$1\033[0m"; }
yellow(){ echo -e "\033[33m$1\033[0m"; }
bold(){ echo -e "\033[1m$1\033[0m"; }

ensure_nm() {
  command -v nmcli >/dev/null || {
    apt update -y
    apt install -y network-manager
    systemctl enable NetworkManager
    systemctl restart NetworkManager
  }
}

detect_ifaces() {
  ensure_nm
  LAN_IFACE=$(nmcli -t -f DEVICE,TYPE d | awk -F: '$2=="ethernet"{print $1;exit}')
  WIFI_IFACE=$(nmcli -t -f DEVICE,TYPE d | awk -F: '$2=="wifi"{print $1;exit}')
}

run_step() {
  local step="$1" label="$2"
  jq -e ".\"$step\"==\"done\"" "$STATE" >/dev/null 2>&1 && {
    yellow "‚úî $label (skipped)"
    return
  }
  printf "‚Ä¢ %-25s" "$label"
  if bash "$PROV/$step.sh"; then
    jq ".+{\"$step\":\"done\"}" "$STATE" > "$STATE.tmp" && mv "$STATE.tmp" "$STATE"
    green "‚úî"
  else
    red "‚úñ"
    exit 1
  fi
}

wifi() {
  ensure_nm
  detect_ifaces
  bold "üì° Wi-Fi Setup"
  nmcli dev wifi list ifname "$WIFI_IFACE"
  read -p "SSID: " SSID
  read -s -p "Password: " PASS; echo
  nmcli dev wifi connect "$SSID" password "$PASS" ifname "$WIFI_IFACE"
}

configure() {
  detect_ifaces
  read -p "Domain [nioxplay.portal]: " SITE_DOMAIN
  SITE_DOMAIN=${SITE_DOMAIN:-nioxplay.portal}

  cat > "$RUNTIME" <<EOF
SITE_DOMAIN=$SITE_DOMAIN
LAN_IFACE=$LAN_IFACE
WIFI_IFACE=$WIFI_IFACE
LAN_IP=10.10.10.1
LAN_NETMASK=24
EOF

  green "‚úî Config saved"
}

install() {
  source "$RUNTIME"

  # Ensure WAN default route
  ip route | grep -q "default.*$WIFI_IFACE" || {
    red "WAN (USB Wi-Fi) is not default route"
    exit 1
  }

  bold "üöÄ Provisioning"
  run_step 00-system "System"
  run_step 01-security "Security"
  run_step 02-network "Network"
  run_step 03-nginx "Nginx"
  run_step 04-php "PHP"
  run_step 05-mysql "MySQL"
  run_step 06-node "Node"
  run_step 07-redis "Redis"
  run_step 08-supervisor "Supervisor"
  run_step 09-app "Laravel App"

  yellow "‚ö† Enabling captive portal (internet stays on Wi-Fi)"
  read -p "Continue? (y/N): " yn; [ "$yn" = y ] || exit 0

  run_step 10-lan "LAN Static IP"
  run_step 11-dns "Captive DNS"
  run_step 12-captive "Captive Portal"

  green "üéâ Done ‚Üí http://$SITE_DOMAIN"
}

doctor() {
  ensure_nm
  detect_ifaces

  echo "Default Route:"
  ip route | grep default || red "‚ùå Missing"

  echo "DNS:"
  getent hosts google.com >/dev/null && green "‚úî OK" || red "‚ùå Broken"

  echo "HTTPS:"
  curl -fsSL https://github.com >/dev/null && green "‚úî OK" || red "‚ùå Blocked"

  echo "Nginx:"
  nginx -t >/dev/null && green "‚úî OK" || red "‚ùå Broken"
}

case "${1:-}" in
  setup) configure && install ;;
  wifi) wifi ;;
  configure) configure ;;
  install) install ;;
  doctor) doctor ;;
  *) echo "nioxon setup | wifi | doctor" ;;
esac
