#!/usr/bin/env bash
set -e

echo "ğŸš€ Installing NIOXON CLI"

# --------------------------------------------------
# Requirements
# --------------------------------------------------
apt update -y
apt install -y git curl ca-certificates

# --------------------------------------------------
# Clone or update repo
# --------------------------------------------------
if [ ! -d /opt/nioxon ]; then
  echo "ğŸ“¥ Cloning repository"
  git clone https://github.com/nioxon/provision.git /opt/nioxon
else
  echo "ğŸ”„ Updating repository"
  cd /opt/nioxon
  git pull
fi

# --------------------------------------------------
# HARD GUARANTEE: CLI FILE EXISTS
# --------------------------------------------------
if [ ! -f /opt/nioxon/bin/nioxon ]; then
  echo "âŒ ERROR: /opt/nioxon/bin/nioxon not found"
  echo ""
  echo "Expected repo structure:"
  echo "  /opt/nioxon/bin/nioxon"
  echo ""
  echo "Fix:"
  echo "  â€¢ Ensure bin/nioxon is committed to GitHub"
  echo "  â€¢ Ensure you are on branch: main"
  exit 1
fi

# --------------------------------------------------
# Make executable
# --------------------------------------------------
chmod +x /opt/nioxon/bin/nioxon

# --------------------------------------------------
# Install GLOBAL launcher (PATH-INDEPENDENT)
# --------------------------------------------------
cat > /usr/bin/nioxon <<'EOF'
#!/usr/bin/env bash
exec /opt/nioxon/bin/nioxon "$@"
EOF

chmod +x /usr/bin/nioxon

# --------------------------------------------------
# VERIFY INSTALLATION (MANDATORY)
# --------------------------------------------------
if ! /usr/bin/nioxon --help >/dev/null 2>&1; then
  echo "âŒ NIOXON CLI verification failed"
  exit 1
fi

echo ""
echo "âœ” NIOXON CLI installed successfully"
echo "ğŸ‘‰ Run: nioxon setup"
