#!/usr/bin/env bash
set -e

BASE_DIR="/opt/nioxon"
PROVISION_DIR="$BASE_DIR/provision"

# Load configs (fail early if missing)
if [ ! -f "$BASE_DIR/config/server.env" ]; then
  echo "‚ùå Missing config/server.env"
  exit 1
fi

if [ ! -f "$BASE_DIR/config/network.env" ]; then
  echo "‚ùå Missing config/network.env"
  exit 1
fi

source "$BASE_DIR/config/server.env"
source "$BASE_DIR/config/network.env"

run() {
  local STEP="$1"
  local SCRIPT="$PROVISION_DIR/$STEP.sh"

  if [ ! -f "$SCRIPT" ]; then
    echo "‚ùå Provision script not found: $STEP.sh"
    exit 1
  fi

  echo ""
  echo "üöÄ Running $STEP"
  echo "----------------------------------------"
  bash "$SCRIPT"
  echo "‚úÖ Completed $STEP"
}

case "$1" in
  install)
    run 00-system
    run 01-security
    run 02-network-manager
    run 03-netplan-lan
    run 04-dns
    run 05-nginx
    run 06-php
    run 07-mysql
    run 08-node
    run 09-redis
    run 10-supervisor
    run 11-site
    run 12-ssl
    run 13-captive
    echo ""
    echo "üéâ NIOXON provisioning completed successfully"
    echo "üëâ You can now access: http://$SITE_DOMAIN"
    ;;
  *)
    echo "Usage:"
    echo "  sudo nioxon install"
    ;;
esac
