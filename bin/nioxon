#!/usr/bin/env bash
set -e

# ==================================================
# Paths
# ==================================================
BASE_DIR="/opt/nioxon"
CONFIG_DIR="$BASE_DIR/config"
PROVISION_DIR="$BASE_DIR/provision"
RUNTIME_ENV="$CONFIG_DIR/runtime.env"

mkdir -p "$CONFIG_DIR"

# ==================================================
# UI Helpers
# ==================================================
green()  { echo -e "\033[32m$1\033[0m"; }
red()    { echo -e "\033[31m$1\033[0m"; }
yellow() { echo -e "\033[33m$1\033[0m"; }
bold()   { echo -e "\033[1m$1\033[0m"; }

# ==================================================
# Safe Internet Check (better than ping)
# ==================================================
require_internet() {
  if ! curl -fsSL https://google.com >/dev/null 2>&1; then
    red "âŒ Internet not available"
    echo "ðŸ‘‰ Run: nioxon wifi"
    exit 1
  fi
}

# ==================================================
# Hardware Detection
# ==================================================
detect_wifi_iface() {
  nmcli -t -f DEVICE,TYPE device | awk -F: '$2=="wifi"{print $1; exit}'
}

detect_lan_iface() {
  nmcli -t -f DEVICE,TYPE device | awk -F: '$2=="ethernet"{print $1; exit}'
}

# ==================================================
# Provision Runner (with visible errors)
# ==================================================
run_step() {
  local script="$1"
  local label="$2"

  printf "â€¢ %-30s" "$label"

  if bash "$PROVISION_DIR/$script"; then
    green "âœ” Done"
  else
    red "âœ– Failed"
    echo ""
    red "----- ERROR OUTPUT ($script) -----"
    bash "$PROVISION_DIR/$script" || true
    red "---------------------------------"
    exit 1
  fi
}

# ==================================================
# Commands
# ==================================================

doctor() {
  bold "ðŸ©º NIOXON Doctor"
  echo ""

  echo "OS       : $(lsb_release -ds 2>/dev/null || echo Unknown)"
  echo "Kernel   : $(uname -r)"
  echo "CPU      : $(nproc) cores"
  echo "Memory   : $(free -h | awk '/Mem:/ {print $2}')"
  echo ""

  LAN_IFACE=$(detect_lan_iface)
  WIFI_IFACE=$(detect_wifi_iface)

  [ -n "$LAN_IFACE" ] && green "âœ” LAN Interface : $LAN_IFACE" || red "âœ– LAN Interface : Not found"
  [ -n "$WIFI_IFACE" ] && green "âœ” Wi-Fi Adapter : $WIFI_IFACE" || red "âœ– Wi-Fi Adapter : Not found"

  if curl -fsSL https://google.com >/dev/null 2>&1; then
    green "âœ” Internet      : Connected"
  else
    yellow "âš  Internet      : Not connected"
    echo "  â†’ Run: nioxon wifi"
  fi
}

wifi() {
  bold "ðŸ“¡ Wi-Fi Setup"
  echo ""

  WIFI_IFACE=$(detect_wifi_iface)

  if [ -z "$WIFI_IFACE" ]; then
    red "No Wi-Fi adapter detected"
    exit 1
  fi

  echo "Detected Wi-Fi device: $WIFI_IFACE"
  echo ""

  if nmcli -t -f DEVICE,STATE device | grep "^$WIFI_IFACE:connected" >/dev/null; then
    green "âœ” Already connected to Wi-Fi"
    return
  fi

  nmcli device wifi list ifname "$WIFI_IFACE"
  echo ""

  read -p "Enter SSID: " SSID
  read -s -p "Enter Wi-Fi password: " PASSWORD
  echo ""

  echo "Connecting..."
  if nmcli device wifi connect "$SSID" password "$PASSWORD" ifname "$WIFI_IFACE"; then
    green "âœ” Connected to $SSID"
  else
    red "âœ– Failed to connect"
    exit 1
  fi

  require_internet
  green "âœ” Internet reachable"
}

configure() {
  bold "âš™ï¸  NIOXON Configuration"
  echo ""

  AUTO_LAN=$(detect_lan_iface)
  AUTO_WIFI=$(detect_wifi_iface)

  read -p "Project name [nioxon]: " PROJECT_NAME
  PROJECT_NAME=${PROJECT_NAME:-nioxon}

  read -p "Domain [nioxplay.local]: " SITE_DOMAIN
  SITE_DOMAIN=${SITE_DOMAIN:-nioxplay.local}

  read -p "LAN interface [$AUTO_LAN]: " LAN_IFACE
  LAN_IFACE=${LAN_IFACE:-$AUTO_LAN}

  read -p "Wi-Fi interface [$AUTO_WIFI]: " WIFI_IFACE
  WIFI_IFACE=${WIFI_IFACE:-$AUTO_WIFI}

  read -p "LAN IP [192.168.1.2]: " LAN_IP
  LAN_IP=${LAN_IP:-192.168.1.2}

  read -p "LAN subnet [24]: " LAN_NETMASK
  LAN_NETMASK=${LAN_NETMASK:-24}

  cat > "$RUNTIME_ENV" <<EOF
# Generated by nioxon configure
PROJECT_NAME=$PROJECT_NAME
SITE_DOMAIN=$SITE_DOMAIN
LAN_IFACE=$LAN_IFACE
LAN_IP=$LAN_IP
LAN_NETMASK=$LAN_NETMASK
WIFI_IFACE=$WIFI_IFACE
EOF

  green "âœ” Configuration saved to $RUNTIME_ENV"
}

install() {
  bold "ðŸš€ NIOXON Provisioning"
  echo ""

  if [ ! -f "$RUNTIME_ENV" ]; then
    yellow "Configuration not found"
    echo "ðŸ‘‰ Run: nioxon configure"
    exit 1
  fi

  source "$RUNTIME_ENV"

  # Safety checks
  require_internet

  if ! nmcli -t -f DEVICE,STATE device | grep ":connected" >/dev/null; then
    yellow "Wi-Fi not connected"
    echo "ðŸ‘‰ Run: nioxon wifi"
    exit 1
  fi

  bold "ðŸ”µ Phase 1 â€” System & Services (Internet required)"
  run_step "system.sh"           "System packages"
  run_step "security.sh"         "Security (UFW / SSH)"
  run_step "network_manager.sh"  "NetworkManager"
  run_step "nginx.sh"            "Nginx"
  run_step "php.sh"              "PHP"
  run_step "mysql.sh"            "MySQL"
  run_step "node.sh"             "Node.js"
  run_step "redis.sh"            "Redis"
  run_step "supervisor.sh"       "Supervisor"

  echo ""
  yellow "âš  Phase 2 â€” LAN & Captive Network (safe offline)"

  run_step "lan_netplan.sh"      "LAN static IP"
  run_step "captive_dns.sh"      "Captive DNS"
  run_step "captive_http.sh"     "Captive HTTP redirect"

  echo ""
  green "ðŸŽ‰ Provisioning completed successfully"
  echo "ðŸ‘‰ Access: http://$SITE_DOMAIN"
}

# ==================================================
# Router
# ==================================================
case "$1" in
  doctor)    doctor ;;
  wifi)      wifi ;;
  configure) configure ;;
  install)   install ;;
  *)
    echo "NIOXON CLI"
    echo ""
    echo "Usage:"
    echo "  nioxon doctor      # system & hardware checks"
    echo "  nioxon wifi        # connect Wi-Fi"
    echo "  nioxon configure   # interactive configuration"
    echo "  nioxon install     # provision server"
    ;;
esac
