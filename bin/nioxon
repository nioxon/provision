#!/usr/bin/env bash
set -e

# ==================================================
# Paths
# ==================================================
BASE_DIR="/opt/nioxon"
CONFIG_DIR="$BASE_DIR/config"
PROVISION_DIR="$BASE_DIR/provision"
RUNTIME_ENV="$CONFIG_DIR/runtime.env"

mkdir -p "$CONFIG_DIR"

# ==================================================
# UI Helpers
# ==================================================
green()  { echo -e "\033[32m$1\033[0m"; }
red()    { echo -e "\033[31m$1\033[0m"; }
yellow() { echo -e "\033[33m$1\033[0m"; }
bold()   { echo -e "\033[1m$1\033[0m"; }

spinner() {
  local pid=$1
  local spin='-\|/'
  while kill -0 "$pid" 2>/dev/null; do
    for i in {0..3}; do
      printf "\r  %s " "${spin:$i:1}"
      sleep 0.1
    done
  done
  printf "\r"
}

# ==================================================
# Internet Check
# ==================================================
require_internet() {
  curl -fsSL https://google.com >/dev/null 2>&1 || {
    red "âŒ Internet not available"
    echo "ðŸ‘‰ Run: nioxon wifi"
    exit 1
  }
}

# ==================================================
# Hardware Detection
# ==================================================
detect_wifi_iface() {
  nmcli -t -f DEVICE,TYPE device | awk -F: '$2=="wifi"{print $1; exit}'
}

detect_lan_iface() {
  nmcli -t -f DEVICE,TYPE device | awk -F: '$2=="ethernet"{print $1; exit}'
}

# ==================================================
# Step Runner
# ==================================================
run_step() {
  local script="$1"
  local label="$2"

  printf "â€¢ %-30s" "$label"
  bash "$PROVISION_DIR/$script.sh" &
  spinner $!
  wait $! && green "âœ” Done" || {
    red "âœ– Failed ($script)"
    exit 1
  }
}

# ==================================================
# Commands
# ==================================================

doctor() {
  bold "ðŸ©º NIOXON Doctor"
  echo ""

  echo "OS     : $(lsb_release -ds 2>/dev/null || echo Unknown)"
  echo "Kernel : $(uname -r)"
  echo "CPU    : $(nproc) cores"
  echo "Memory : $(free -h | awk '/Mem:/ {print $2}')"
  echo ""

  LAN=$(detect_lan_iface)
  WIFI=$(detect_wifi_iface)

  [[ -n "$LAN" ]] && green "âœ” LAN  : $LAN" || red "âœ– LAN  : Not found"
  [[ -n "$WIFI" ]] && green "âœ” WiFi : $WIFI" || red "âœ– WiFi : Not found"

  curl -fsSL https://google.com >/dev/null && \
    green "âœ” Internet : Connected" || \
    yellow "âš  Internet : Not connected"
}

wifi() {
  bold "ðŸ“¡ Wi-Fi Setup"
  WIFI=$(detect_wifi_iface)

  [[ -z "$WIFI" ]] && { red "No Wi-Fi adapter found"; exit 1; }

  if nmcli -t -f DEVICE,STATE device | grep "^$WIFI:connected" >/dev/null; then
    green "âœ” Already connected"
    return
  fi

  nmcli device wifi list ifname "$WIFI"
  read -rp "SSID: " SSID
  read -rsp "Password: " PASS; echo ""

  nmcli device wifi connect "$SSID" password "$PASS" ifname "$WIFI"
  require_internet
  green "âœ” Internet reachable"
}

configure() {
  bold "âš™ï¸  Configuration"

  LAN=$(detect_lan_iface)
  WIFI=$(detect_wifi_iface)

  read -rp "Project name [nioxon]: " PROJECT
  PROJECT=${PROJECT:-nioxon}

  read -rp "Domain [nioxplay.local]: " DOMAIN
  DOMAIN=${DOMAIN:-nioxplay.local}

  read -rp "LAN IP [192.168.1.2]: " LAN_IP
  LAN_IP=${LAN_IP:-192.168.1.2}

  cat > "$RUNTIME_ENV" <<EOF
PROJECT_NAME=$PROJECT
SITE_DOMAIN=$DOMAIN
LAN_IFACE=$LAN
LAN_IP=$LAN_IP
LAN_NETMASK=24
WIFI_IFACE=$WIFI
EOF

  green "âœ” Configuration saved"
}

install() {
  bold "ðŸš€ Provisioning"

  [[ ! -f "$RUNTIME_ENV" ]] && {
    red "Run: nioxon configure first"
    exit 1
  }

  source "$RUNTIME_ENV"
  require_internet

  bold "ðŸ”µ Phase 1 â€” System"
  run_step "00" "System update"
    run_step "01" "Security setup"
    run_step "02" "NetworkManager"
    run_step "03" "Nginx"
    run_step "04" "PHP"
    run_step "05" "MySQL"
    run_step "06" "Node.js"
    run_step "07" "Redis"
    run_step "08" "Supervisor"

    echo ""
    yellow "âš  Applying LAN & captive network (internet no longer required)"

    run_step "11" "LAN netplan"
    run_step "12" "Captive DNS"
    run_step "13" "Captive redirect"

  green "ðŸŽ‰ Done â†’ http://$SITE_DOMAIN"
}

setup() {
  bold "ðŸ§­ Guided Setup"
  doctor
  wifi || true
  configure
  install
}

status() {
  bold "ðŸ“Š Status"
  systemctl is-active nginx >/dev/null && green "âœ” Nginx" || red "âœ– Nginx"
  systemctl is-active redis-server >/dev/null && green "âœ” Redis" || red "âœ– Redis"
  systemctl is-active dnsmasq >/dev/null && green "âœ” DNS" || red "âœ– DNS"
}

uninstall() {
  bold "ðŸ§¹ Uninstall"
  read -rp "Remove NIOXON completely? [y/N]: " A
  [[ "$A" != "y" ]] && exit 0
  rm -rf /opt/nioxon /usr/bin/nioxon
  green "âœ” Removed"
}

# ==================================================
# Router
# ==================================================
case "$1" in
  setup) setup ;;
  doctor) doctor ;;
  wifi) wifi ;;
  configure) configure ;;
  install) install ;;
  status) status ;;
  uninstall|reset) uninstall ;;
  *)
    echo "NIOXON CLI"
    echo ""
    echo "Commands:"
    echo "  nioxon setup"
    echo "  nioxon doctor"
    echo "  nioxon wifi"
    echo "  nioxon configure"
    echo "  nioxon install"
    echo "  nioxon status"
    echo "  nioxon uninstall"
    ;;
esac
